<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>GSC Explorer</title>
	<meta name="viewport" content="width=device-width, initial-scale=1"/>
	<link rel="shortcut icon" href="data:image/svg+xml,%3Csvg%20xmlns='http://www.w3.org/2000/svg'%20viewBox='0%200%2016%2016'%3E%3Ctext%20x='0'%20y='14'%3Esf%3C/text%3E%3C/svg%3E" type="image/svg+xml" />
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
	<style type="text/css">
		#sfgsc-explore-result {
			overflow: scroll;
		}
	</style>
</head>
<body>
	
	<nav class="navbar-light bg-light mb-4">
		<div class="nav nav-tabs" role="tablist">
			<button class="nav-link disabled" id="sfgsc-nav-tab-authenticate" type="button" role="tab">Stefans GSC API Explorer</button>
			<button class="nav-link active" id="sfgsc-nav-tab-authenticate" data-bs-toggle="tab" data-bs-target="#sfgsc-tab-authenticate" type="button" role="tab">Authenticate</button>
			<button class="nav-link" id="sfgsc-nav-tab-query" data-bs-toggle="tab" data-bs-target="#sfgsc-tab-query" type="button" role="tab">Query</button>
			<button class="nav-link" id="sfgsc-nav-tab-explore" data-bs-toggle="tab" data-bs-target="#sfgsc-tab-explore" type="button" role="tab">Explore</button>
			<button class="nav-link" id="sfgsc-nav-tab-store" data-bs-toggle="tab" data-bs-target="#sfgsc-tab-store" type="button" role="tab">Download</button>
		</div>
	</nav>
	
	
	<!-- AUTHENTICATE -->
	<div class="tab-pane fade show active" id="sfgsc-tab-authenticate" role="tabpanel">
		<div class="container mt-5">
			<div class="row sfgsc-dynamic-content sfgsc-logged-in">
				<div class="col">Your're successfuly logged in!</div>
			</div>
			<form id="sfgsc-get-authcode-form" class="row sfgsc-dynamic-content sfgsc-no-refresh-token">
				<div class="col-12">
					<label for="sfgsc-client-id">Google Client ID:</label>
					<input id="sfgsc-client-id" class="form-control" type="text" value="" placeholder="client-id">
				</div>
				<div class="col-12">
					<button class="btn btn-primary">Get Authcode</button>
				</div>
			</form>
			<form id="sfgsc-set-credentials-form" class="row sfgsc-dynamic-content sfgsc-no-refresh-token">
				<div class="col-12 mt-5">
					<label for="">Google AuthCode:</label>
					<input id="sfgsc-authcode" class="form-control" type="text" value="" placeholder="AuthCode starting with 4/....">
				</div>
				<div class="col-12">
					<button class="btn btn-primary">Save</button>
				</div>
			</form>
			<form id="sfgsc-refresh-login-form" class="row sfgsc-dynamic-content sfgsc-no-access-token">
				<div class="col-12">
					<button class="btn btn-primary">Refresh Login</button>
				</div>
			</form>
		</div>
	</div>
	
	
	<!-- DOWNLOAD (STORE) -->
	<div class="tab-pane fade" id="sfgsc-tab-store" role="tabpanel">
		<div class="container">
			<form id="sfgsc-store-form" class="sfgsc-dynamic-content sfgsc-logged-in">
				<div class="row">
					<div class="col">
						Date: <input type="date" id="sfgsc-store-date" name="sfgsc-store-date" class="form-control">
					</div>
					<div class="col">
						Type:
						<select id="sfgsc-store-type" name="sfgsc-store-type" class="form-control">
							<option value="web">Web (default)</option>
							<option value="discover">Discover</option>
							<option value="image">Image</option>
							<option value="googleNews">Google News</option>
							<option value="news">News</option>
							<option value="video">Video</option>
						</select>
					</div>
				</div>
				<div class="row mb-3">
					<div class="col">
						<label class="form-check-label" for="sfgsc-store-site">Website</label>:
						<input id="sfgsc-store-site" name="sfgsc-store-site" class="form-control" type="text" value="" placeholder="https://www.example.com">
					</div>
				</div>
				<div class="row mt-3">
					<div class="col">
						<button id="sfgsc-store-request-data" class="btn btn-primary">Request Data</button>
					</div>
					<div class="col">
						<button id="sfgsc-set-next-day" class="btn btn-outline-secondary" type="button">Set next day</button>
						<button id="sfgsc-set-oldest-date" class="btn btn-outline-secondary" type="button">Set oldest date</button>
					</div>
				</div>
			</form>
			<div class="row mt-3">
				<div class="col" id="sfgsc-store-messages"></div>
			</div>
			<div class="row mt-3">
				<form class="col mb-3">
					<a id="sfgsc-store-download-detailed" href="#" class="btn btn-sm btn-primary" style="display: none;" download>Download Detailed Data</a>
					<a id="sfgsc-store-download-general" href="#" class="btn btn-sm btn-primary" style="display: none;" download>Download General Data</a>
				</form>
			</div>
			<div class="row mt-3">
				<div class="col sfgsc-dynamic-content sfgsc-no-access-token">
					Please authenticate first
				</div>
			</div>
		</div>
	</div>
	
	
	<!-- QUERY -->
	<div class="tab-pane fade" id="sfgsc-tab-query" role="tabpanel">
		<div class="container">
			<form id="sfgsc-query-form" class="sfgsc-dynamic-content sfgsc-logged-in">
				<div class="row">
					<div class="col">
						Start date: <input type="date" id="sfgsc-query-start-date" name="sfgsc-query-start-date" class="form-control" required>
					</div>
					<div class="col">
						End date: <input type="date" id="sfgsc-query-end-date" name="sfgsc-query-end-date" class="form-control" required>
					</div>
					<div class="col">
						Dimensions:
						<select multiple="multiple" id="sfgsc-query-dimensions" name="sfgsc-query-dimensions" class="form-control">
							<option value="country">Country</option>
							<option value="date">Date</option>
							<option value="device">Device</option>
							<option value="page">Page</option>
							<option value="query">Query</option>
							<option value="search_appearance">Search Appearance</option>
						</select>
					</div>
					<div class="col">
						Type:
						<select id="sfgsc-query-type" name="sfgsc-query-type" class="form-control" required>
							<option value="web" selected>Web</option>
							<option value="discover">Discover</option>
							<option value="image">Image</option>
							<option value="googleNews">Google News</option>
							<option value="news">News</option>
							<option value="video">Video</option>
						</select>
					</div>
				</div>
				<div class="row mt-3">
					<div class="col">
						<label class="form-check-label" for="sfgsc-query-site">Website</label>:
						<input id="sfgsc-query-site" class="form-control" type="text" value="" placeholder="https://www.example.com" required>
					</div>
					<div class="col">
						Start Row:
						<input type="number" value="0" id="sfgsc-query-start-row" name="sfgsc-query-start-row" class="form-control" required>
					</div>
					<div class="col">
						Row Limit:
						<input type="number" value="25000" id="sfgsc-query-row-limit" name="sfgsc-query-row-limit" class="form-control" required>
					</div>
					<div class="col">
						Aggregation Type:
						<select id="sfgsc-query-aggregation-type" name="sfgsc-query-aggregation-type" class="form-control" required>
							<option value="auto" selected>Auto</option>
							<option value="by_property">Property</option>
							<option value="by_page">Page</option>
						</select>
					</div>
				</div>
				<div class="row mt-3">
					<div class="col">Filter (optional):</div>
				</div>
				<div class="row mt-3 sfgsc-query-filters">
					<div class="col">
						Dimension:
						<select class="sfgsc-query-filter-dimension form-control">
							<option value="">Please select:</option>
							<option value="country">Country</option>
							<option value="device">Device</option>
							<option value="page">Page</option>
							<option value="query">Query</option>
							<option value="search_appearance">Search Appearance</option>
						</select>
					</div>
					<div class="col">
						Operator:
						<select class="sfgsc-query-filter-operator form-control">
							<option value="">Please select:</option>
							<option value="contains">Contains</option>
							<option value="notContains">Not Contains</option>
							<option value="equals">Equals</option>
							<option value="notEquals">Not Equals</option>
							<option value="includingRegex">Including REGEX</option>
							<option value="excludingRegex">Excluding REGEX</option>
						</select>
					</div>
					<div class="col">
						Expression:
						<input type="text" value="" class="sfgsc-query-filter-expression form-control">
					</div>
				</div>
				<div class="row mt-3 sfgsc-query-filters">
					<div class="col">
						Dimension:
						<select class="sfgsc-query-filter-dimension form-control">
							<option value="">Please select:</option>
							<option value="country">Country</option>
							<option value="device">Device</option>
							<option value="page">Page</option>
							<option value="query">Query</option>
							<option value="search_appearance">Search Appearance</option>
						</select>
					</div>
					<div class="col">
						Operator:
						<select class="sfgsc-query-filter-operator form-control">
							<option value="">Please select:</option>
							<option value="contains">Contains</option>
							<option value="notContains">Not Contains</option>
							<option value="equals">Equals</option>
							<option value="notEquals">Not Equals</option>
							<option value="includingRegex">Including REGEX</option>
							<option value="excludingRegex">Excluding REGEX</option>
						</select>
					</div>
					<div class="col">
						Expression:
						<input type="text" value="" class="sfgsc-query-filter-expression form-control">
					</div>
				</div>
				<div class="row mt-3">
					<div class="col">
						<button class="btn btn-primary">Run Query</button>
					</div>
					<div class="col">
						<button id="sfgsc-query-set-last-month" class="btn btn-outline-secondary" type="button">Last Full Month</button>
						<button id="sfgsc-query-set-last-year" class="btn btn-outline-secondary" type="button">Last Year</button>
					</div>
				</div>
			</form>
			<div class="row mt-3">
				<div class="col sfgsc-dynamic-content sfgsc-no-access-token">
					Please authenticate first
				</div>
			</div>
		</div>
	</div>


	<!-- EXPLORE -->
	<div class="tab-pane fade" id="sfgsc-tab-explore" role="tabpanel">
		<div class="container">
			<form id="sfgsc-explore-form" class="sfgsc-dynamic-content sfgsc-logged-in">
				<div class="row mb-3">
					<div class="col">
						<textarea id="sfgsc-command" rows="12" class="form-control"></textarea>
					</div>
				</div>
				<div class="row mb-3">
					<div class="col">
						<label class="form-check-label" for="sfgsc-explore-site">Website</label>:
						<input id="sfgsc-explore-site" class="form-control" type="text" value="" placeholder="https://www.example.com">
					</div>
				</div>
				<div class="row mb-3">
					<div class="col">
						<button class="btn btn-primary">Run Query</button>
					</div>
					<div class="col">
						<button id="sfgsc-load-last-explore-query" class="btn btn-outline-secondary" type="button">Load last query</button>
					</div>
				</div>
			</form>
			<div class="row mb-3">
				<div class="col sfgsc-dynamic-content sfgsc-no-access-token">
					Please authenticate first
				</div>
			</div>
			<div class="row mt-5">
				<div class="col">
					<div id="sfgsc-explore-chart" style="width: 100%; height: 500px"></div>
				</div>
			</div>
			<div class="row mt-5">
				<div class="col sfgsc-dynamic-content sfgsc-no-access-token" id="sfgsc-explore-chart-buttons">
					<button id="sfgsc-explore-show-daily" class="btn btn-outline-secondary" type="button">Daily</button>
					<button id="sfgsc-explore-show-weekly" class="btn btn-outline-secondary" type="button">Weekly</button>
					<button id="sfgsc-explore-show-monthly" class="btn btn-outline-secondary" type="button">Monthly</button>
				</div>
			</div>
			<div class="row mt-5">
				<form class="col mb-3">
					<a id="sfgsc-download-result" href="#" class="btn btn-sm btn-outline-secondary" style="display: none;" download>Download</a>
				</form>
			</div>
			<div class="row mt-5">
				<div class="col">
					<div id="sfgsc-explore-result"></div>
				</div>
			</div>
		</div>
	</div>


	<!-- Alerts -->
	<div id="sfgsc-alert-danger" class="alert alert-danger alert-dismissible fade" role="alert">
		<span></span>
		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
	</div>
	<div id="sfgsc-alert-info" class="alert alert-info alert-dismissible fade" role="alert">
		<span></span>
		<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close">
	</div>
	
	



	<script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
	
	<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js" integrity="sha512-xQBQYt9UcgblF6aCMrwU1NkVA7HCXaSN2oq0so80KO+y68M+n64FOcqgav4igHe6D5ObBLIf68DWv+gfBowczg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

	<script>
		"use strict";

		/************************************************************
		 *
		 *	C O N F I G U R A T I O N
		 *
		 ************************************************************/

		const MY_CLIENT_ID = '131566363760-dsuv7nhsdl48rqodhdq6gujnf7unf5us.apps.googleusercontent.com'
		const MY_CLIENT_SECRET = '9kGhMPQ6f2NxHWfZm4R9w1Vc'
		const LOCAL_STORAGE_CREDENTIALS_KEY = 'sf-gsc-credentials'
		const LOCAL_STORAGE_SETTINGS_KEY = 'sf-gsc-settings'
		
		
		/************************************************************
		 *
		 *	C O D E
		 *
		 ************************************************************/
		
		$(function () {
			
			const { Toast } = bootstrap;
			
			let CREDENTIALS = read_credentials()
			console.log(CREDENTIALS)
			update_ui()

			let CONFIG = {
				REDIRECT_URI: document.URL,
				CLIENT_ID: MY_CLIENT_ID,
				CLIENT_SECRET: MY_CLIENT_SECRET,
				SCOPE: 'https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fwebmasters',
				RESPONSE_TYPE: 'code',
				REDIRECT_URI: 'urn:ietf:wg:oauth:2.0:oob',
				REFRESH_URI: 'https://accounts.google.com/o/oauth2/token',
				QUERY_URI: 'https://www.googleapis.com/webmasters/v3/sites/###SITE###/searchAnalytics/query?access_token=###TOKEN###',
				PAGE_SIZE: 25000
			}
			
			let EXPLORE_CHART = null
			let CHART_OPTIONS = {
				chart: {
					title: 'Chart',
					legend: { position: 'bottom' },
				},
				series: {
					0: {axis: 'clicks'},
					1: {axis: 'impressions'},
				},
				axes: {
					y: {
						clicks: {label: 'Clicks'},
						impressions: {label: 'Impressions'}
					},
				}
			}
			
		
			$('#sfgsc-client-id').val(CONFIG.CLIENT_ID)
			
			let last_download_data = null
			let download_blob = null
			let EXPLORE_SITE = ""
			let flattened = []
			
			
			// Populate "Store" tab with data from last call
			$('#sfgsc-store-site').val( get_setting('store-site') )
			$('#sfgsc-store-date').val( get_date_by_days( get_setting('store-date'), 1) )
			
			// Populate "Query" tab with data from last call
			$('#sfgsc-query-site').val( get_setting('query-site') )
			$('#sfgsc-query-start-date').val( (new Date()).toISOString().split('T')[0] )
			$('#sfgsc-query-end-date').val( (new Date()).toISOString().split('T')[0] )
			
			
			// Show and hide all tabs (aweful solution to prevent some UI problems)
			let tab_elems = document.querySelectorAll('div.tab-pane')
			for( let i = 0; i < tab_elems.length; ++i ) {
				$(tab_elems[i]).show()
				$(tab_elems[i]).hide()
			}
			
			
			/************************************************
				EVENTS
			 ************************************************/
			
			//
			// DOWNLOAD/STORE: Download data for a SEO warehouse
			//
			$('#sfgsc-store-form').on('submit', event => {
				$('#sfgsc-store-download-detailed').hide()
				$('#sfgsc-store-download-general').hide()
				$('#sfgsc-store-download-detailed').addClass('btn-primary')
				$('#sfgsc-store-download-detailed').removeClass('btn-outline-success')
				$('#sfgsc-store-download-general').addClass('btn-primary')
				$('#sfgsc-store-download-general').removeClass('btn-outline-success')
				$('#sfgsc-store-messages').html('')
				let store_site = $('#sfgsc-store-site').val()
				let my_date = $('#sfgsc-store-date').val()
				let search_type = $('#sfgsc-store-type').val()
				let query_obj_default = {
					'type': search_type,
					'startDate': my_date,
					'endDate': my_date,
					'rowLimit': CONFIG.PAGE_SIZE,
					'startRow': 0,
					'dimensions': ['date', 'query', 'page', 'device', 'country']
				}
				let all_data = { 'detailed': [], 'general': [] }
				$('#sfgsc-store-messages').append(`Please wait while getting data for ${my_date} ...<br>`)
				// Fetch detailed data
				let query_obj = JSON.parse(JSON.stringify(query_obj_default))
				fetch_paged(query_obj, store_site, 0, (data) => {
					// store data
					all_data.detailed = all_data.detailed.concat(data.rows)
				}, () => {
					// Finished detailed data
					let my_flattened = flatten_gsc_data(query_obj, all_data.detailed)
					download_blob = new Blob( [array_to_csv(my_flattened)], {type:'application/octet-stream'} )
					let download_blob_url = URL.createObjectURL(download_blob)
					let filename = create_csv_filename(store_site, query_obj.startDate, 'detailed', search_type)
					$('#sfgsc-store-download-detailed').attr('download', filename)
					$('#sfgsc-store-download-detailed').attr('href', download_blob_url)
					$('#sfgsc-store-download-detailed').show()
					
					// Fetch general data
					query_obj = JSON.parse(JSON.stringify(query_obj_default))
					query_obj.dimensions = ['date', 'page', 'device', 'country']
					fetch_paged(query_obj, store_site, 0, (data) => {
						// store data
						all_data.general = all_data.general.concat(data.rows)
					}, () => {
						// Finished general data
						let my_flattened = flatten_gsc_data(query_obj, all_data.general)
						download_blob = new Blob( [array_to_csv(my_flattened)], {type:'application/octet-stream'} )
						let download_blob_url = URL.createObjectURL(download_blob)
						let filename = create_csv_filename(store_site, query_obj.startDate, 'general', search_type)
						$('#sfgsc-store-download-general').attr('download', filename)
						$('#sfgsc-store-download-general').attr('href', download_blob_url)
						$('#sfgsc-store-download-general').show()
					})
				})
				event.preventDefault()
			})
			
			
			//
			// QUERY: Submit custom query
			//
			$('#sfgsc-query-form').on('submit', event => {
				// console.log( $('#sfgsc-query-dimensions').val() )
				let query_obj = {
					'type': $('#sfgsc-query-type').val(),
					'startDate': $('#sfgsc-query-start-date').val(),
					'endDate': $('#sfgsc-query-end-date').val(),
					'rowLimit': $('#sfgsc-query-row-limit').val(),
					'startRow': $('#sfgsc-query-start-row').val()
				}
				let dimensions = $('#sfgsc-query-dimensions').val()
				if( dimensions ) {
					query_obj.dimensions = dimensions
				}
				let filter = []
				$('.sfgsc-query-filters').each(function(idx, item) {
					let my_filter_dimension = $(item).find('.sfgsc-query-filter-dimension').val()
					let my_filter_operator = $(item).find('.sfgsc-query-filter-operator').val()
					let my_filter_expression = $(item).find('.sfgsc-query-filter-expression').val()
					// console.log( my_filter_dimension )
					// console.log( my_filter_operator )
					// console.log( my_filter_expression )
					let my_filter = {}
					if( my_filter_dimension && my_filter_operator && my_filter_expression ) {
						my_filter.dimension = my_filter_dimension
						my_filter.operator = my_filter_operator
						my_filter.expression = my_filter_expression
						filter.push(my_filter)
					}
				})
				if( filter.length >= 1 ) {
					query_obj.dimensionFilterGroups = [
						{
							'filters': filter
						}
					]
				}
				let aggregation_type = $('#sfgsc-query-aggregation-type').val()
				if( aggregation_type != 'auto' ) {
					query_obj.aggregationType = aggregation_type
				}
				let query = JSON.stringify(query_obj, null, 2)
				let query_site = $('#sfgsc-query-site').val()
				update_settings({
					'query-site': query_site,
				})
				// Switch to "Explore" and prefill fields
				$('#sfgsc-command').val(query)
				$('#sfgsc-explore-site').val(query_site)
				$('#sfgsc-download-result').hide()
				$('#sfgsc-explore-result').html("")
				$('#sfgsc-explore-chart').html("")
				$('#sfgsc-explore-chart-buttons').hide()
				$('#sfgsc-nav-tab-explore').click()
				$('#sfgsc-explore-form').submit()
				event.preventDefault()
			})


			//
			// EXPLORE: Execute JSON formatted query
			//
			$('#sfgsc-explore-form').on('submit', event => {
				$('#sfgsc-download-result').hide()
				$('#sfgsc-explore-result').html("")
				$('#sfgsc-explore-chart').html("")
				$('#sfgsc-explore-chart-buttons').hide()
				last_download_data = null
				let query = $('#sfgsc-command').val()
				EXPLORE_SITE = $('#sfgsc-explore-site').val()
				fetch_api_data(query, EXPLORE_SITE)
				.then( (response) => {
					update_settings({
						'explore-site': EXPLORE_SITE,
						'explore-query': query
					})
					show_explore_result(response.query, response.data, {
						'table': true,
						'chart': true,
						'download': true
					})
				})
				.catch( (error) => {})
				event.preventDefault()
			})
			
			
			// Download data
			$('#sfgsc-download-result').on('click', event => {
				console.log("download")
				setTimeout(URL.revokeObjectURL, 5000, download_blob);
			})
			
			
			// EXPLORE: Load last query and site
			$('#sfgsc-load-last-explore-query').on('click', event => {
				$('#sfgsc-command').val( get_setting('explore-query') )
				$('#sfgsc-explore-site').val( get_setting('explore-site') )
			})
			
			// EXPLORE: Toggle between daily, weekly and monthly view
			$('#sfgsc-explore-show-daily').on('click', event => {
				update_explore_chart('daily')
			})
			$('#sfgsc-explore-show-weekly').on('click', event => {
				update_explore_chart('weekly')
			})
			$('#sfgsc-explore-show-monthly').on('click', event => {
				update_explore_chart('monthly')
			})
			
			// STORE: Set next day
			$('#sfgsc-set-next-day').on('click', event => {
				console.log("set next day")
				$('#sfgsc-store-date').val( get_date_by_days( $('#sfgsc-store-date').val(), 1) )
			})
			
			// STORE: Set oldest date with data
			$('#sfgsc-set-oldest-date').on('click', event => {
				$('#sfgsc-store-date').val( get_date_by_days( '', -500) )
			})
			
			
			$('#sfgsc-store-download-general').on('click', event => {
				$(event.target).removeClass('btn-primary')
				$(event.target).addClass('btn-outline-success')
			})
			$('#sfgsc-store-download-detailed').on('click', event => {
				$(event.target).removeClass('btn-primary')
				$(event.target).addClass('btn-outline-success')
			})
			
			
			// QUERY: Set last month
			$('#sfgsc-query-set-last-month').on('click', event => {
				let last_month = get_month_first_last(null, -1)
				$('#sfgsc-query-start-date').val( get_iso_date(last_month.first) )
				$('#sfgsc-query-end-date').val( get_iso_date(last_month.last) )
			})
			
			// QUERY: Set last year
			$('#sfgsc-query-set-last-year').on('click', event => {
				let last_month = get_month_first_last(null, -1)
				let last_year_month = get_month_first_last(null, -12)
				$('#sfgsc-query-start-date').val( get_iso_date(last_year_month.first) )
				$('#sfgsc-query-end-date').val( get_iso_date(last_month.last) )
			})
			
			// Fetch AuthCode from Google
			$('#sfgsc-get-authcode-form').on('submit', event => {
				let authcode_url = build_url_authcode()
				console.log(authcode_url)
				let authcode_win = window.open(authcode_url, '_blank');
				if( authcode_win ) {
					authcode_win.focus();
				} else {
					show_alert('Please allow popups for this website');
				}
				event.preventDefault()
			})
			
			
			// Fetch Refresh Token
			// 4/1AX4XfWjbvwlAl51zN5HZentMI8X2mlpdqzrLMWTW-9n5sEJqS0sgB2NHSuE
			$('#sfgsc-set-credentials-form').on('submit', event => {
				let authcode = $('#sfgsc-authcode').val()
				console.log(authcode)
				let request_data = {
					code: authcode,
					client_id: CONFIG.CLIENT_ID,
					client_secret: CONFIG.CLIENT_SECRET,
					redirect_uri: CONFIG.REDIRECT_URI,
					grant_type: 'authorization_code'
				}
				console.log(request_data)
				$.ajax({
					url: CONFIG.REFRESH_URI,
					method: 'POST',
					data: request_data,
				})
				.done( response => {
					console.log(response)
					store_credentials(response)
				})
				.fail( response => {
					console.log(response)
					let html = `Error: ${response.responseJSON.error}<br>Description: ${response.responseJSON.error_description}`
					show_alert('danger', html)
				})
				.always( _ => {
					update_ui()
				})
				event.preventDefault()
			})
			
			
			// Fetch Access Token
			$('#sfgsc-refresh-login-form').on('submit', event => {
				console.log("refresh")
				update_access_token()
				event.preventDefault()
			})
			
			
			// Do some UI adaptions when Tab changes
			tab_elems = document.querySelectorAll('button[data-bs-toggle="tab"]')
			for( let i = 0; i < tab_elems.length; ++i ) {
				tab_elems[i].addEventListener('show.bs.tab', function (event) {
					let new_tab = $(event.target).attr('data-bs-target')
					let prev_tab = $(event.relatedTarget).attr('data-bs-target')
					$(new_tab).show()
					$(prev_tab).hide()
				})
			}
			
			
			/************************************************
				FUNCTIONS
			 ************************************************/
			
			
			
			/**
				Fetches the data as described by query_obj and pages through the results.
			
				@param query_obj Query to execute as an object
				@param store_site The site that gets queried
				@param page The page number of the results
				@param store_cb Callback function that stores the result from the API call
				@param finished_cb Gets called when all pages have been queried
			 */
			function fetch_paged(query_obj, store_site, page, store_cb, finished_cb) {
				let start_row = page * CONFIG.PAGE_SIZE
				query_obj.startRow = start_row
				console.log(query_obj)
				let query = JSON.stringify(query_obj)
				fetch_api_data(query, store_site)
				.then( (response) => {
					console.log( response.data )
					if( 'rows' in response.data ) {
						update_settings({
							'store-site': store_site,
							'store-date': query_obj.startDate
						})
						store_cb(response.data)
						$('#sfgsc-store-messages').append(`Fetched ${response.data.rows.length} rows!<br>`)
						if( response.data.rows.length >= CONFIG.PAGE_SIZE ) {
							fetch_paged(query_obj, store_site, page+1, store_cb, finished_cb)
						} else {
							finished_cb()
						}
					} else {
						$('#sfgsc-store-messages').append('Could not find any data!')
						finished_cb()
					}
				})
				.catch( (error) => {})
			}
			
			
			/**
				@param query JSON formatted string
				@param site Site to fetch data from
				@param success_cb A function that's called on success (with query_obj and response as parameters)
			 */
			function fetch_api_data(query, site, success_cb) {
				let query_obj = null
				try {
					query_obj = JSON.parse(query)
				} catch {
					console.log("Query is no valid JSON")
					query = null
				}
				if( !query_obj ) {
					console.log("Query not valid")
					show_alert('danger', "Query not valid")
					show_custom_toast("Error", "Query not valid", "", 'error')
					return
				}
				if( !/^(sc\-domain\:)|(https?\:\/\/).*$/.test(site) ) {
					console.log("Invalid site")
					console.log(site)
					show_alert('danger', "Invalid site")
					show_custom_toast("Error", "Invalid site", "", 'error')
					return
				}
				let query_url = CONFIG.QUERY_URI
					.replace('###SITE###', encodeURIComponent(site))
					.replace('###TOKEN###', encodeURIComponent(CREDENTIALS.access_token))
				return new Promise((resolve, reject) => {
					$.ajax({
						url: query_url,
						method: 'POST',
						data: query,
						dataType: 'json',
						contentType: 'application/json',
					})
					.success( response => {
						resolve( {
							'data': response,
							'query': query_obj
						})
					})
					.error( error => {
						console.log(error)
						let html = `Error: ${error.responseJSON.error}<br>Description: ${error.responseJSON.error_description}`
						if( error.status == 401 ) {
							update_access_token()
							// show_alert('info', 'You\'ve been logged out. Please re-run your query.')
							show_custom_toast("Info", "Logged out", "You've been logged out. Please re-run your query.", 'info')
						} else {
							show_custom_toast("Error", "Query not valid", error.responseJSON.error.message, 'error')
						}
						reject(error)
					})
				})
			}
			
			
			/**
				@param query_obj Query that's been used to fetch the data
				@param response The response from the API (containing 'rows' item)
				@param display What should be displayed? { 'table': true, 'chart': true, 'download': true }
			 */
			function show_explore_result(query_obj, response, display) {
				let out = ''
				$('#sfgsc-explore-chart').attr('style', 'width: 100%; height: 0px')
				$('#sfgsc-explore-chart-buttons').hide()
				if( 'rows' in response) {
					flattened = flatten_gsc_data(query_obj, response.rows)
					last_download_data = {
						'original': response,
						'flattened': flattened,
					}
					out += '<p>Results: ' + response.rows.length + '</p>'
					if( display.table ) {
						out += '<table class="table table-striped"><tr>'
						out += '<th>#</th>'
						for( const col_index in flattened[0] ) {
							out += `<th>${flattened[0][col_index]}</th>`
						}
						out += '</tr>'
						for( const row_index in flattened ) {
							if( row_index == 0) {
								continue
							}
							out += '<tr><td>'+row_index+'</td>'
							for( const col_index in flattened[row_index]) {
								let val = flattened[row_index][col_index]
								if( val !== undefined ) {
									if( flattened[0][col_index] == 'page' ) {
										let shortened_url = val.substr(-60)
										val = `<a href="${val}">${shortened_url}</a>`
									}
									if( flattened[0][col_index] == 'ctr' || flattened[0][col_index] == 'position' ) {
										val = val.toFixed(2)
									}
								} else {
									val = 'n/a'
								}
								out += `<td>${val}</td>`
							}
							out += '</tr>'
						}
						out += '</table>'
					}
					if( display.download ) {
						download_blob = new Blob( [array_to_csv(last_download_data.flattened)], {type:'application/octet-stream'} )
						let download_blob_url = URL.createObjectURL(download_blob)
						$('#sfgsc-download-result').attr('download', 'gsc.csv')
						$('#sfgsc-download-result').attr('href', download_blob_url)
						$('#sfgsc-download-result').show()
					}
					if( display.chart ) {
						if( flattened[0][0] == 'date' && flattened[0][1] == 'clicks') {
							$('#sfgsc-explore-chart').attr('style', 'width: 100%; height: 500px')
							CHART_OPTIONS.chart.title = EXPLORE_SITE
							google.charts.load('current', {'packages':['line']})
							google.charts.setOnLoadCallback(show_explore_chart_cb)
							$('#sfgsc-explore-chart-buttons').show()
						} else {
							$('#sfgsc-explore-chart').attr('style', 'width: 100%; height: 0px')
							$('#sfgsc-explore-chart-buttons').hide()
						}
					}
				} else {
					out = "No data in response from API"
				}
				$('#sfgsc-explore-result').html(out)
			}
			
			
			function show_explore_chart_cb() {
				let my_flattened = cut_columns(flattened, [0,1,2])
				let data = google.visualization.arrayToDataTable(my_flattened)
				EXPLORE_CHART = new google.charts.Line(document.getElementById('sfgsc-explore-chart'))
				EXPLORE_CHART.draw(data, CHART_OPTIONS)
			}
			
			function update_explore_chart(group_by) {
				if( group_by === undefined ) {
					group_by = 'daily'
				}
				let my_flattened = cut_columns(flattened, [0,1,2])
				let my_grouped = group_daily_chart_data(my_flattened, group_by)
				let data = google.visualization.arrayToDataTable(my_grouped)
				EXPLORE_CHART.draw(data, CHART_OPTIONS)
			}
			
			
			/**
				Expects daily sorted data in rows and groups it as 'weekly' data
			 */
			function group_daily_chart_data(rows, group_by) {
				let new_data = [rows[0]]
				let last_row = []
				let date_format_options = { month: 'short'}
				for( let i = 1; i < rows.length; ++i ) {
					let key = rows[i][0]
					let key_date = new Date(key)
					if( group_by == 'weekly' ) {
						key = 'KW ' + key_date.getWeekNumber().toString()
					}
					if( group_by == 'monthly' ) {
						key = new Intl.DateTimeFormat('en-US', date_format_options).format(key_date)
					}
					if( i == 1 ) {
						last_row = [key]
						last_row.push(...rows[i].slice(1))
					} else if( key == last_row[0] ) {
						for( let j = 1; j < rows[i].length; ++j ) {
							last_row[j] += rows[i][j]
						}
					} else {
						new_data.push( last_row )
						last_row = [key]
						last_row.push(...rows[i].slice(1))
					}
				}
				new_data.push( last_row )
				return new_data
			}
			
			
			function flatten_gsc_data(query_obj, rows) {
				let my_flattened = []
				let columns = []
				let keys = query_obj.dimensions
				if( keys ) {
					for( const key in keys ) {
						columns.push(keys[key])
					}
				}
				columns.push(...['clicks', 'impressions', 'ctr', 'position'])
				my_flattened.push(columns)
				for( let i = 0; i < rows.length; ++i ) {
					let row = []
					if( keys ) {
						for( const key in rows[i].keys ) {
							row.push(rows[i].keys[key])
						}
					}
					row.push(rows[i].clicks)
					row.push(rows[i].impressions)
					row.push(rows[i].ctr)
					row.push(rows[i].position)
					my_flattened.push(row)
				}
				return my_flattened
			}
			
			
			function update_ui() {
				$('.sfgsc-dynamic-content').hide()
				if( !CREDENTIALS || !CREDENTIALS.refresh_token ) {
					$('.sfgsc-no-refresh-token').show()
				} else if( !CREDENTIALS.access_token ) {
					$('.sfgsc-no-access-token').show()
				} else if( CREDENTIALS.access_token ) {
					$('.sfgsc-logged-in').show()
				}
			}
			
			
			function update_access_token() {
				let request_data = {
					client_id: CONFIG.CLIENT_ID,
					client_secret: CONFIG.CLIENT_SECRET,
					refresh_token: CREDENTIALS.refresh_token,
					grant_type: 'refresh_token'
				}
				console.log(request_data)
				$.ajax({
					url: CONFIG.REFRESH_URI,
					method: 'POST',
					data: request_data,
				})
				.done( response => {
					console.log(response)
					store_credentials(response)
				})
				.fail( response => {
					console.log(response)
					let html = `Error: ${response.responseJSON.error}<br>Description: ${response.responseJSON.error_description}`
					show_alert('danger', html)
				})
				.always( _ => {
					update_ui()
				})
			}
			
			
			//
			// Build URL to fetch AuthCode from Google
			function build_url_authcode() {
				let redirec_uri_encoded = encodeURIComponent(CONFIG.REDIRECT_URI)
				return `https://accounts.google.com/o/oauth2/v2/auth?scope=${CONFIG.SCOPE}&response_type=${CONFIG.RESPONSE_TYPE}&redirect_uri=${redirec_uri_encoded}&client_id=${CONFIG.CLIENT_ID}`
			}
			
			
			//
			// Stores the credentials that were returned from Google's OAuth2 login with AuthCode
			function store_credentials(response) {
				let refresh_token = response.refresh_token ? response.refresh_token : CREDENTIALS.refresh_token
				let access_token = response.access_token ? response.access_token : CREDENTIALS.access_token
				let new_credentials = {
					access_token: access_token,
					refresh_token: refresh_token,
					expires: response.expires_in + get_unix_timestamp()
				}
				console.log(new_credentials)
				localStorage.setItem(LOCAL_STORAGE_CREDENTIALS_KEY, JSON.stringify(new_credentials))
				CREDENTIALS = new_credentials
			}
			
			
			function read_credentials() {
				let credentials = null
				if( localStorage.getItem(LOCAL_STORAGE_CREDENTIALS_KEY) !== null ) {
					credentials = JSON.parse( localStorage.getItem(LOCAL_STORAGE_CREDENTIALS_KEY) )
					credentials.ttl = credentials.expires - get_unix_timestamp()
					if( credentials.ttl < 0 ) {
						credentials.access_token = null;
					}
				}
				return credentials
			}
			
			
			function get_setting(key, def) {
				let ret = def !== undefined ? def : "" 
				let stored_settings = JSON.parse( localStorage.getItem(LOCAL_STORAGE_SETTINGS_KEY) )
				if( stored_settings && key in stored_settings ) {
					ret = stored_settings[key]
				}
				return ret
			}
			
			
			/**
				Updates settings (stored in localStorage) with the items in the given object.
				If an item's value is set to `undefined`, this item is deleted.
			
				@param {obj} new_settings Object with the options that should be stored
			*/
			function update_settings(new_settings) {
				let stored_settings = null
				try{
					stored_settings = JSON.parse( localStorage.getItem(LOCAL_STORAGE_SETTINGS_KEY) )
				} catch {}
				if( stored_settings === null ) {
					stored_settings = {}
				}
				for( const key in new_settings ) {
					if( new_settings[key] === undefined ) {
						delete stored_settings[key]
					} else {
						stored_settings[key] = new_settings[key]
					}
				}
				localStorage.setItem(LOCAL_STORAGE_SETTINGS_KEY, JSON.stringify(stored_settings) )
			}
			
			
			function show_alert(type, msg) {
				console.log("show_alert")
				let alert_id = 'sfgsc-alert-' + type
				$('#' + alert_id + ' > span').html(msg)
				$('#' + alert_id + '').addClass("show")
				let alert = document.getElementById(alert_id)
				console.log(alert)
				new bootstrap.Alert(alert)
			}
			
			function show_custom_toast(header, header_small, body, type) {
				let options = {
					delay: 5000,
				}
				let html_id = "_sfgsc-toast-" + Math.floor( Math.random()*100000 );
				let bg_color = 'bg-primary'
				let text_color = 'text-white'
				if( type == 'error' || type == 'danger') {
					bg_color = 'bg-danger'
				}
				if( type == 'warning' ) {
					bg_color = 'bg-warning'
					text_color = 'text-dark'
				}
				if( type == 'success' ) {
					bg_color = 'bg-success'
					text_color = 'text-white'
				}
				let html = `<div aria-atomic="true" aria-live="assertive" class="toast ${text_color} ${bg_color} position-absolute top-50 start-50 translate-middle" role="alert" id="${html_id}">
					<div class="toast-header">
						<strong class="me-auto">${header}</strong>
						<small>${header_small}</small>
						<button aria-label="Close" class="btn-close" data-bs-dismiss="toast" type="button"></button>
					</div>
					<div class="toast-body">
						${body}
					</div>
				</div>`;
				let template = document.createElement('template');
				template.innerHTML = html;
				let toast_elem = template.content.firstChild;
				document.body.appendChild(toast_elem);
				let my_toast = new Toast(toast_elem, options);
				my_toast.show();
				setTimeout(() => {
					document.body.removeChild(toast_elem);
				}, options.delay + 200);
			}
			
			
			function array_to_csv(data) {
				let str = ''
				for( let r = 0; r < data.length; ++r ) {
					let line = ''
					for( let c = 0; c < data[r].length; ++c ) {
						let cell
						if( data[r][c] !== undefined ) {
							cell = data[r][c].toString().replaceAll(/"/g, '""')
						} else {
							cell = 'n/a'
						}
						if( c > 0 ) {
							line += ','
						}
						line += '"' + cell + '"'
					}
					str += line + "\r\n"
				}
				return str
			}
			
			function get_unix_timestamp() {
				return Math.floor(Date.now() / 1000)
			}
			
			function cut_columns(flattened, keep) {
				for( let i = 0; i < flattened.length; ++i ) {
					let tmp = []
					for( let j = 0; j < keep.length; ++j) {
						tmp.push(flattened[i][keep[j]])
					}
					flattened[i] = tmp
				}
				return flattened
			}
			
			
			/**
				@param start_date string YYYY-MM-DD, describing a date or empty string for today's date
				@param days number of days to add to start_date
			 */
			function get_date_by_days(start_date, days) {
				let my_date
				if( start_date == '' ) {
					my_date = new Date()
				} else {
					my_date = new Date(start_date)
				}
				my_date.setDate( my_date.getDate() + days )
				return my_date.toISOString().split('T')[0]
			}
			
			
			/**
				Returns an object with the first and the last day in the month of the given date
			
				@param my_date Date (Format: YYYY-MM-DD)
				@param month_diff Number of months to add or to substract from my_date
			 */
			function get_month_first_last(my_date, month_diff) {
				if( !my_date ) {
					my_date = new Date()
				}
				if( month_diff === undefined ) {
					month_diff = 0
				}
				let date = new Date(my_date)
				let first_day = new Date(date.getFullYear(), date.getMonth() + month_diff, 1)
				let last_day = new Date(date.getFullYear(), date.getMonth() + month_diff + 1, 0)
				return {
					'first': get_iso_date(first_day),
					'last': get_iso_date(last_day)
				}
			}
			
			
			/**
				Returns the YYYY-MM-DD date string of my_date
			 */
			function get_iso_date(my_date) {
				if( typeof my_date === 'string' || my_date instanceof String) {
					my_date = new Date(my_date)
				}
				let my_day = my_date.getDate().toString()
				if( my_day < 10 ) {
					my_day = '0' + my_day
				}
				let my_month = (my_date.getMonth() + 1).toString()
				if( my_month < 10 ) {
					my_month = '0' + my_month
				}
				return my_date.getFullYear() + '-' + my_month + '-' + my_day
			}
			
			
			/**
				Creates the file name to store the GSC API data
				@param site The URL of the site thats queried
				@param date The ISO date string
				@param query_type "detailed" or "generic"
				@param search_type The search type like "web" or "image"
			 */
			function create_csv_filename(site, date, query_type, search_type) {
				// Convert site URL to a useful string
				let filename = site.replace(/https?\:\/\//i, '')
				filename = filename.replace(/[\.\-\/]+/g, "-")
				filename = filename.replace(/\-+$/, '')
				// Add date, query_type and search_type
				filename = filename + '_' + date + '_' + query_type.toLowerCase() + '_' + search_type.toLowerCase()
				// Add extension
				filename = filename + '.csv'
				return filename
			}
			
		})
		// https://stackoverflow.com/a/6117889/2771733
		Date.prototype.getWeekNumber = function(){
			var d = new Date(Date.UTC(this.getFullYear(), this.getMonth(), this.getDate()))
			var dayNum = d.getUTCDay() || 7
			d.setUTCDate(d.getUTCDate() + 4 - dayNum)
			var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1))
			return Math.ceil((((d - yearStart) / 86400000) + 1)/7)
		}
	</script>
</body>
</html>
